<!DOCTYPE html>

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채권 조회</title>
    
    <link rel="stylesheet" type="text/css" th:href="@{/bootstrapLux.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- 네비게이션바 프라그먼트-->
    <nav th:replace="~{navbar :: navbarFragment}"></nav>
    
	<!-- 수정 모달 -->
	<div class="modal" id="myModal">
	    <div class="modal-dialog">
	        <div class="modal-content">
	            <!-- 모달 헤더 -->
	            <div class="modal-header">
	                <h4 class="modal-title">채권 수정</h4>
	                <button type="button" class="close" data-dismiss="modal">&times;</button>
	            </div>
	            <!-- 모달 본문 -->
	            <div class="modal-body">
					
					<!-- 수정 내용 -->
		 			<form id="bondForm" th:action="@{/AC/bondupdate}" method="post">
						
						채권 번호: <span id="bondNumberField"></span><br>
						
						<label for="type">증감 구분:</label>
						<select id="type" name="type" onchange="showPriceField()">
						    <option value="" selected>선택하세요</option>
						    <option value="추가">추가</option>
						    <option value="할인">할인</option>
						</select><br>
						
						<div id="priceLabel" style="display:none;">
						    <label for="priceField" id="priceLabelName"></label>
						    <input type="number" id="priceField" name="priceField" value="0"><br>
						</div>
				
				        <label for="amount">변제 금액:</label>
				        <input type="number" id="amount" name="amount" value="0"><br>
				
				        <label for="maturityDate">만기일 변경:</label>
				        <input type="date" id="maturityDate" name="maturityDate"><br>
				        
				        <input type="hidden" id="bondNumber" name="bondNumber">
				        
				        <input type="submit" value="수정">
				    </form>
	            </div>
	            <!-- 모달 푸터 -->
	            <div class="modal-footer">
	                <button type="button" class="btn btn-primary">저장</button>
	            </div>
	        </div>
	    </div>
	</div>
	
    <div class="container-fluid">
        <div class="row">

            <!-- 아코디언 메뉴 칼럼 프라그먼트 (5분의 1 크기) -->
            <div class="col-lg-2">
                <div th:replace="~{AC_arcodian :: arcodianFragment}"></div>
            </div>

            <!-- 테이블 컬럼 (1:4 비율) -->
            <div class="col-lg-10">
                <!-- 조건 조회 버튼 시작-->
                <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                    <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" value="option1" th:checked="${option == 'option1'}">
                    <label class="btn btn-outline-primary" for="btnradio1">채권 관리</label>
                    <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off" value="option2" th:checked="${option == 'option2'}">
                    <label class="btn btn-outline-primary" for="btnradio2">채무 관리</label>
                </div>
                <!-- 조건 조회 버튼 끝-->
                
                <!-- 옵션 1일때 시작 -->
                <div id="option1Content" style="display: none;">
                    <!-- 데이터 테이블 시작-->
				   <table class = "table table-hover">
				        <thead>
				            <tr class="table-active">
				                <th>채권 번호</th>
				                <th>발생 일자</th>
				                <th>거래처</th>
				                <th>최초 금액</th>
				                <th>증감구분</th>
				                <th>남은 금액</th>
				                <th>만기 일자</th>
				                <th>적요</th>
				            </tr>
				        </thead>
				        <tbody>
				            <!-- for each 문 -->
				            <tr th:each="bond : ${bonds}">
				                <!--화면에 띄울 정보-->
				                <td th:text="${bond.bondNumber}"></td>
				                <td th:text="${bond.date}"></td>
				                <td th:text="${bond.trader}"></td>
				                <td th:text="${bond.amount}"></td>
				                <td th:text="${bond.increaseDecreaseType}"></td>
				                <td th:text="${bond.balance}"></td>
				                <td th:text="${bond.maturityDate}"></td>
				                <td th:text="${bond.description}"></td>
				                <!-- 수정 버튼 추가 -->
							    <td>
							        <button class="btn btn-primary open-modal" data-toggle="modal" data-target="#myModal">수정</button>
							    </td>
				            </tr>
				        </tbody>
				    </table>
                    <!-- 데이터 테이블 끝-->
	                <!-- 페이징 프라그먼트 -->
					<div th:replace="~{paging::pagingFragment(paging=${bonds})}"></div>
					<!-- 버튼 프라그먼트 -->
					<div th:replace="~{AC_bond_debt_botton::bottonFragment}"></div>
                </div> <!-- 옵션 1일 때 리스트 -->
                
                <!-- 옵션 2일때 시작 -->
                <div id="option2Content" style="display: none;">
                    <!-- 데이터 테이블 시작-->
				    <table class = "table table-hover">
				        <thead>
				            <tr class="table-active">
				                <th>채무 번호</th>
				                <th>발생 일자</th>
				                <th>거래처</th>
				                <th>최초 금액</th>
				                <th>증감구분</th>
				                <th>남은 금액</th>
				                <th>만기 일자</th>
				                <th>적요</th>
				            </tr>
				        </thead>
				        <tbody>
				            <!-- for each 문 -->
				            <tr th:each="debt : ${debts}">
				                <!-- 화면에 띄울 정보 -->
				                <td th:text="${debt.debtNumber}"></td>
				                <td th:text="${debt.date}"></td>
				                <td th:text="${debt.trader}"></td>
				                <td th:text="${debt.amount}"></td>
				                <td th:text="${debt.increaseDecreaseType}"></td>
				                <td th:text="${debt.balance}"></td>
				                <td th:text="${debt.maturityDate}"></td>
				                <td th:text="${debt.description}"></td>
				            </tr>
				        </tbody>
				    </table>
                    <!-- 데이터 테이블 끝-->
                   	<!-- 페이징 프라그먼트 -->
					<div th:replace="~{paging::pagingFragment(paging=${debts})}"></div>
					<!-- 버튼 프라그먼트 -->
					<div th:replace="~{AC_bond_debt_botton::bottonFragment}"></div>
                </div> <!-- 옵션 2일 때 리스트 -->
            </div> <!-- 테이블 컬럼 끝(1:4 비율) -->
        </div> <!-- 컨테이너 플루이드 정의 끝 -->
    </div> <!-- 컨테이너 플루이드 끝 -->
    
    <!-- Bootstrap JS 연결 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<script>
	    $(document).ready(function () {
	        var selectedOption = localStorage.getItem('selectedOption') || "option1";
	        var currentPage = localStorage.getItem('currentPage') || 1;
	
	        if (selectedOption === "option1") {
	            $("#option1Content").show();
	            $("#option2Content").hide();
	        } else if (selectedOption === "option2") {
	            $("#option1Content").hide();
	            $("#option2Content").show();
	        }
	        $("input[name='btnradio'][value='" + selectedOption + "']").prop('checked', true);
	
	        // 라디오 버튼 변경 시 로컬 스토리지에 저장
	        $("input[name='btnradio']").change(function () {
	            selectedOption = $(this).val();
	            localStorage.setItem('selectedOption', selectedOption);
	            
	            // 페이지를 0으로 설정
	            localStorage.setItem('currentPage', 0);
	            
	            // 현재 URL에서 페이지 파라미터를 제거한 뒤 페이지를 0으로 설정하여 리로드
	            var currentUrl = window.location.href.split('?')[0];
	            window.location.href = currentUrl + "?page=0";
	        });
	    });
	</script>
	
	<script>
        // 수정 버튼 클릭 시 모달 열기
	    $(document).on('click', '.open-modal', function() {
	        // 클릭된 버튼이 속한 행을 찾습니다.
	        var $row = $(this).closest('tr');
	        // 행에서 첫 번째 열의 텍스트(채권 번호)를 가져옵니다.
	        var bondNumber = $row.find('td:first').text().trim();
	        // 가져온 채권 번호를 출력합니다.
	        $('#bondNumberField').text(bondNumber);
        	$('#bondNumber').val(bondNumber);
            // 모달 열기
            $('#myModal').modal('show');
		
		    // 모달 닫기 버튼 클릭 시 모달 닫기
		    $(document).on('click', '.close', function() {
		        $('#myModal').modal('hide');
			    });	    
		});
	</script>

	<script>
		// 추가 / 할인 버튼을 선택시 추가 입력 필드란 보이게 하기
	    function showPriceField() {
	        var selectBox = document.getElementById("type");
	        var selectedValue = selectBox.options[selectBox.selectedIndex].value;
	        var priceLabel = document.getElementById("priceLabel");
	
	        if (selectedValue === "추가") {
	            priceLabel.style.display = "block";
	            document.getElementById("priceLabelName").textContent = "추가 금액:";
	        } else if (selectedValue === "할인") {
	            priceLabel.style.display = "block";
	            document.getElementById("priceLabelName").textContent = "할인 금액:";
	        } else {
	            priceLabel.style.display = "none";
	    	}
	    }
	</script>
	
    <script>
		// 오늘 날짜를 가져오는 함수
	    function getTodayDate() {
	        var today = new Date();
	        var dd = String(today.getDate()).padStart(2, '0');
	        var mm = String(today.getMonth() + 1).padStart(2, '0'); // 1월은 0으로 시작하므로 1을 더해줍니다.
	        var yyyy = today.getFullYear();
	
	        return yyyy + '-' + mm + '-' + dd;
	    }
	
	    // maturityDate 입력 필드의 min 속성을 오늘 날짜로 설정
	    document.getElementById('maturityDate').min = getTodayDate();

	</script>
	
	<script>
	    document.querySelector('#bondForm').addEventListener('submit', function(event) {
	        var priceField = document.getElementById('priceField').value;
	        var amount = document.getElementById('amount').value;
	        var maturityDate = document.getElementById('maturityDate').value;
	        
	        // 증감 구분, 만기일자가 null 값이고, 변제 금액이 0인 경우 폼 제출을 막음
	        if (priceField === '0' && !maturityDate && amount === '0') {
	            event.preventDefault(); // 폼 제출 막기
	            alert('하나 이상의 변경값을 입력해 주세요.'); // 사용자에게 알림
	        }
	    });
	</script>
</body>
</html>